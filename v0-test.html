<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V0前端API集成测试</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; }
        .config-section { margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff; }
        .test-section { margin-bottom: 20px; }
        .status { padding: 10px; border-radius: 6px; margin: 10px 0; font-weight: bold; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.loading { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .code { background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 14px; overflow-x: auto; }
        .api-url { background: #e3f2fd; padding: 10px; border-radius: 4px; margin: 10px 0; font-family: monospace; word-break: break-all; }
        button { background: #007bff; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; margin: 5px; font-size: 14px; }
        button:hover { background: #0056b3; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0; }
        .card { background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; }
        .metric { text-align: center; }
        .metric-value { font-size: 2em; color: #007bff; font-weight: bold; }
        .metric-label { color: #666; font-size: 0.9em; }
        .response-box { max-height: 300px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 6px; white-space: pre-wrap; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚕 GPS数据API - V0前端集成测试</h1>
            <p>测试GitHub Pages部署的GPS出租车数据API</p>
        </div>
        
        <!-- API配置 -->
        <div class="config-section">
            <h3>🔧 API配置</h3>
            <label>GitHub Pages API地址:</label>
            <input type="text" id="api-url-input" placeholder="https://YOUR-USERNAME.github.io/YOUR-REPO-NAME" 
                   style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px;">
            <button onclick="updateAPIUrl()">更新API地址</button>
            <button onclick="testExampleAPI()">测试示例API</button>
            
            <div class="api-url">
                <strong>当前API地址:</strong> <span id="current-api-url">未设置</span>
            </div>
        </div>
        
        <!-- 连接状态 -->
        <div class="test-section">
            <h3>📡 连接状态</h3>
            <div id="connection-status" class="status loading">检查连接中...</div>
            <button onclick="checkConnection()">重新检查连接</button>
        </div>
        
        <!-- API测试 -->
        <div class="test-section">
            <h3>🧪 API端点测试</h3>
            <div class="grid">
                <div class="card">
                    <h4>📅 日期列表</h4>
                    <button onclick="testDatesAPI()">获取日期</button>
                    <div id="dates-result" class="metric">
                        <div class="metric-value" id="dates-count">-</div>
                        <div class="metric-label">可用日期</div>
                    </div>
                </div>
                
                <div class="card">
                    <h4>🗺️ 轨迹数据</h4>
                    <button onclick="testTrajectoryAPI()">获取轨迹</button>
                    <div class="metric">
                        <div class="metric-value" id="points-count">-</div>
                        <div class="metric-label">GPS轨迹点</div>
                    </div>
                </div>
                
                <div class="card">
                    <h4>📊 数据摘要</h4>
                    <button onclick="testSummaryAPI()">获取摘要</button>
                    <div class="metric">
                        <div class="metric-value" id="summary-status">-</div>
                        <div class="metric-label">数据概况</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- V0集成代码 -->
        <div class="test-section">
            <h3>💻 V0前端集成代码</h3>
            <p>复制以下代码到你的V0前端项目中：</p>
            
            <h4>React/Next.js Hook:</h4>
            <div class="code" id="react-code">// 点击"更新API地址"后自动生成</div>
            
            <h4>原生JavaScript:</h4>
            <div class="code" id="vanilla-code">// 点击"更新API地址"后自动生成</div>
        </div>
        
        <!-- API响应 -->
        <div class="test-section">
            <h3>📥 API响应数据</h3>
            <div class="response-box" id="api-response">点击上方按钮测试API，响应数据将显示在这里...</div>
        </div>
    </div>

    <script>
        let currentAPIUrl = '';
        
        function updateAPIUrl() {
            const input = document.getElementById('api-url-input');
            const url = input.value.trim();
            
            if (!url) {
                alert('请输入GitHub Pages API地址');
                return;
            }
            
            // 验证URL格式
            try {
                new URL(url);
            } catch (e) {
                alert('请输入有效的URL地址');
                return;
            }
            
            currentAPIUrl = url;
            document.getElementById('current-api-url').textContent = url;
            
            // 生成集成代码
            generateIntegrationCode(url);
            
            // 自动检查连接
            checkConnection();
        }
        
        function testExampleAPI() {
            document.getElementById('api-url-input').value = 'https://example-user.github.io/taxi-gps-api';
            updateAPIUrl();
        }
        
        async function checkConnection() {
            if (!currentAPIUrl) {
                document.getElementById('connection-status').innerHTML = '<div class="status error">请先设置API地址</div>';
                return;
            }
            
            const statusEl = document.getElementById('connection-status');
            statusEl.innerHTML = '<div class="status loading">检查连接中...</div>';
            
            try {
                const response = await fetch(`${currentAPIUrl}/api/dates.json`, {
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    statusEl.innerHTML = `<div class="status success">✅ 连接成功！找到 ${data.dates ? data.dates.length : 0} 个可用日期</div>`;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                statusEl.innerHTML = `<div class="status error">❌ 连接失败: ${error.message}</div>`;
            }
        }
        
        async function testDatesAPI() {
            if (!currentAPIUrl) {
                alert('请先设置API地址');
                return;
            }
            
            try {
                const response = await fetch(`${currentAPIUrl}/api/dates.json`);
                const data = await response.json();
                
                document.getElementById('dates-count').textContent = data.dates ? data.dates.length : 0;
                document.getElementById('api-response').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('dates-count').textContent = 'ERROR';
                document.getElementById('api-response').textContent = `错误: ${error.message}`;
            }
        }
        
        async function testTrajectoryAPI() {
            if (!currentAPIUrl) {
                alert('请先设置API地址');
                return;
            }
            
            try {
                const response = await fetch(`${currentAPIUrl}/data/taxi_data_2013-09-12.json`);
                const data = await response.json();
                
                document.getElementById('points-count').textContent = data.sampled || data.points?.length || 0;
                
                // 只显示前10个点，避免响应过大
                const preview = {
                    ...data,
                    points: data.points ? data.points.slice(0, 10) : [],
                    note: data.points?.length > 10 ? `显示前10个点，实际有${data.points.length}个点` : ''
                };
                
                document.getElementById('api-response').textContent = JSON.stringify(preview, null, 2);
            } catch (error) {
                document.getElementById('points-count').textContent = 'ERROR';
                document.getElementById('api-response').textContent = `错误: ${error.message}`;
            }
        }
        
        async function testSummaryAPI() {
            if (!currentAPIUrl) {
                alert('请先设置API地址');
                return;
            }
            
            try {
                const response = await fetch(`${currentAPIUrl}/api/summary.json`);
                const data = await response.json();
                
                document.getElementById('summary-status').textContent = '✅ OK';
                document.getElementById('api-response').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('summary-status').textContent = '❌ ERR';
                document.getElementById('api-response').textContent = `错误: ${error.message}`;
            }
        }
        
        function generateIntegrationCode(apiUrl) {
            // React Hook代码
            const reactCode = `// React/Next.js Hook for GPS Data
import { useState, useEffect } from 'react';

const API_BASE_URL = '${apiUrl}';

export function useGPSData(date = '2013-09-12') {
  const [data, setData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  
  useEffect(() => {
    const fetchData = async () => {
      try {
        setLoading(true);
        const response = await fetch(\`\${API_BASE_URL}/data/taxi_data_\${date}.json\`);
        
        if (!response.ok) {
          throw new Error(\`HTTP \${response.status}\`);
        }
        
        const gpsData = await response.json();
        setData(gpsData);
        setError(null);
      } catch (err) {
        setError(err.message);
        console.error('GPS数据获取失败:', err);
      } finally {
        setLoading(false);
      }
    };
    
    fetchData();
  }, [date]);
  
  return { data, loading, error };
}

// 使用示例
function GPSMap({ selectedDate }) {
  const { data, loading, error } = useGPSData(selectedDate);
  
  if (loading) return <div>加载中...</div>;
  if (error) return <div>错误: {error}</div>;
  if (!data) return <div>无数据</div>;
  
  return (
    <div>
      <h3>GPS轨迹 - {data.date}</h3>
      <p>轨迹点数: {data.sampled}</p>
      {/* 渲染地图组件 */}
      {data.points.map(([lng, lat, timestamp, flag], index) => (
        <MapMarker 
          key={index}
          lng={lng} 
          lat={lat}
          color={flag === 1 ? '#ff0000' : '#808080'}  // 红色=载客，灰色=空车
        />
      ))}
    </div>
  );
}`;
            
            // 原生JavaScript代码
            const vanillaCode = `// 原生JavaScript GPS数据获取
const API_BASE_URL = '${apiUrl}';

// GPS数据API客户端
class GPSDataClient {
  constructor() {
    this.cache = new Map();
  }
  
  async fetchWithCache(endpoint) {
    if (this.cache.has(endpoint)) {
      return this.cache.get(endpoint);
    }
    
    const response = await fetch(\`\${API_BASE_URL}\${endpoint}\`);
    if (!response.ok) {
      throw new Error(\`HTTP \${response.status}: \${response.statusText}\`);
    }
    
    const data = await response.json();
    this.cache.set(endpoint, data);
    return data;
  }
  
  async getTrajectoryData(date = '2013-09-12') {
    return this.fetchWithCache(\`/data/taxi_data_\${date}.json\`);
  }
  
  async getAvailableDates() {
    const data = await this.fetchWithCache('/api/dates.json');
    return data.dates;
  }
}

// 使用示例
const gpsClient = new GPSDataClient();

// 获取并处理GPS数据
async function loadGPSData(date = '2013-09-12') {
  try {
    const data = await gpsClient.getTrajectoryData(date);
    console.log(\`获得 \${data.sampled} 个GPS轨迹点\`);
    
    // 处理轨迹数据
    data.points.forEach(([lng, lat, timestamp, flag]) => {
      const status = flag === 1 ? '载客' : '空车';
      const color = flag === 1 ? '#ff0000' : '#808080';
      
      // 添加到地图
      addMapMarker({ lng, lat, status, color });
    });
    
    return data;
  } catch (error) {
    console.error('GPS数据加载失败:', error);
    throw error;
  }
}

// 调用示例
loadGPSData('2013-09-12')
  .then(data => console.log('数据加载成功:', data.date))
  .catch(error => console.error('加载失败:', error));`;
            
            document.getElementById('react-code').textContent = reactCode;
            document.getElementById('vanilla-code').textContent = vanillaCode;
        }
    </script>
</body>
</html>